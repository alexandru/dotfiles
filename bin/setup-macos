#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(dirname $0)"
cd "$SCRIPT_DIR" || exit 1

brew upgrade
brew install --quiet \
  1password-cli \
  ag \
  ast-grep \
  coursier \
  direnv \
  expect \
  fd \
  gradle \
  haskell-stack \
  jenv \
  kotlin \
  lazygit \
  neovim \
  nvm \
  opam \
  pyenv \
  pyenv-virtualenv \
  python \
  rbenv \
  rclone \
  ripgrep \
  ruby \
  ruby-build \
  rustup-init \
  sbt \
  scala \
  telnet \
  terminal-notifier \
  tesseract \
  tree \
  wget

brew upgrade --cask
brew install --cask \
  android-platform-tools \
  font-fira-code \
  font-fira-code-nerd-font \
  jordanbaird-ice \
  neovide

make -C "$HOME/bin/" clean all

# ---------------------
# Setting env variables
{
  echo "# ------------------------"
  echo "# Cloudflare secrets"
  echo "export CLOUDFLARE_AUTH_EMAIL=\"$(op read "op://Private/CloudFlare/email")\""
  echo "export CLOUDFLARE_AUTH_KEY=\"$(op read "op://Private/CloudFlare/Api Key/Global")\""
  echo "# ------------------------"
  echo "# NextDNS secrets"
  echo "export NEXTDNS_API_KEY=\"$(op read "op://Private/NextDNS/Api Key")\""
  echo "export NEXTDNS_PROFILE_ID=\"$(op read "op://Private/NextDNS/Profiles/ING")\""
  echo "# -=-=-=-=-=-=-=-=-=-=-=-="
} >~/.secrets

chmod go-rwx "$HOME/.secrets"

# ---------------------
# Configuring Notes
if [ ! -d "$HOME/Wiki" ]; then
  git clone git@github.com:alexandru/alexn.org.git "$HOME/Wiki"
fi
if [ ! -d "$HOME/Notes" ]; then
  git clone git@github.com:alexandru/notes.git "$HOME/Notes"
fi

# -----------------------
# Configuring screenshots

mkdir -p ~/Screenshots/{Processing,Raw,OCR}
defaults write com.apple.screencapture location ~/Screenshots/Processing
if [[ -z "$(launchctl list | grep my.screenshot.ocr)" ]]; then
  launchctl load -w ~/Library/LaunchAgents/my.sync.ocr.plist
fi

# -----------------------
# Configuring notes
if [[ -z "$(launchctl list | grep my.notes)" ]]; then
  launchctl load -w ~/Library/LaunchAgents/my.notes.plist
fi

# For VS Code + vim key bindings
defaults write com.microsoft.VSCode ApplePressAndHoldEnabled -bool false
# IntelliJ IDEA CE + Ideavim
defaults write com.jetbrains.intellij.ce ApplePressAndHoldEnabled -bool false

# defaults write -g ApplePersistence -bool no
# defaults write -app 'preview' ApplePersistence -bool no
# defaults write com.apple.TextEdit ApplePersistence -bool no
# defaults write com.apple.TextEdit AutosavingDelay -int 0
